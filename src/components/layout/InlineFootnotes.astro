---
/**
 * InlineFootnotes - Progressive enhancement for footnotes
 *
 * When included on a page with footnotes, clicking a footnote reference
 * shows the footnote content inline below the current paragraph instead
 * of jumping to the footnotes section at the bottom.
 *
 * This is a progressive enhancement - without JS, footnotes work normally
 * with anchor links to the footnotes section.
 *
 * Usage: Add <InlineFootnotes /> to any layout that renders markdown with footnotes.
 * The script gracefully no-ops if no footnotes exist on the page.
 */
---

<style is:global>
  /* Inline footnotes - container for footnote content shown inline */
  .inline-footnote-container {
    font-size: var(--font-size-sm);
    padding: var(--space-s);
    margin-top: var(--space-xs);
    position: relative;

    /* Hide the return link - not needed for inline footnotes */
    [data-footnote-backref] {
      display: none;
    }
  }

  .inline-footnote-close {
    position: absolute;
    top: var(--space-2xs);
    right: var(--space-2xs);
    border: none;
    background: transparent;
    color: var(--color-text-secondary);
    font-size: 1.2rem;
    line-height: 1;
    padding: 0.25rem;
    opacity: 0.6;
    transition: opacity var(--duration-fast);

    &:hover {
      opacity: 1;
    }
  }
</style>

<script>
  document.querySelectorAll('a[data-footnote-ref]').forEach(el => {
    const elm = el as HTMLAnchorElement;
    const footnoteId = elm.getAttribute('href')?.slice(1);
    if (!footnoteId) return;
    const footnoteElement = document.getElementById(footnoteId);

    // Find the closest block-level parent (p, div, li, etc.)
    const closestBlock = elm.closest(
      'p, .intro-paragraph, li, blockquote, div.longform-prose > *'
    );
    if (!closestBlock || !footnoteElement?.firstElementChild) return;

    const inlineFootNoteContainer = document.createElement('div');
    inlineFootNoteContainer.classList.add('inline-footnote-container', 'card-surface');
    inlineFootNoteContainer.style.display = 'none';

    // Close button
    const closeBtn = document.createElement('button');
    closeBtn.classList.add('inline-footnote-close');
    closeBtn.innerHTML = 'Ã—';
    closeBtn.setAttribute('aria-label', 'Close footnote');
    closeBtn.addEventListener('click', () => {
      inlineFootNoteContainer.style.display = 'none';
    });

    inlineFootNoteContainer.appendChild(closeBtn);
    inlineFootNoteContainer.appendChild(footnoteElement.firstElementChild.cloneNode(true));
    closestBlock.insertAdjacentElement('afterend', inlineFootNoteContainer);

    elm.addEventListener('click', e => {
      e.preventDefault();
      inlineFootNoteContainer.style.display =
        inlineFootNoteContainer.style.display === 'none' ? 'block' : 'none';
    });
  });
</script>
