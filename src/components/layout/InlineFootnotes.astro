---
/**
 * InlineFootnotes - Progressive enhancement for footnotes
 *
 * When included on a page with footnotes, clicking a footnote reference
 * shows the footnote content inline below the current paragraph instead
 * of jumping to the footnotes section at the bottom.
 *
 * This is a progressive enhancement - without JS, footnotes work normally
 * with anchor links to the footnotes section.
 *
 * Usage: Add <InlineFootnotes /> to any layout that renders markdown with footnotes.
 * The script gracefully no-ops if no footnotes exist on the page.
 */
---

<style is:global>
  /* Inline footnotes - container for footnote content shown inline */
  .inline-footnote-container {
    font-size: var(--font-size-sm);
    padding: var(--space-xs);
    padding-right: var(--space-xl); /* Space for close button */
    margin-top: var(--space-s);
    position: relative;
    background: transparent;
    border: var(--border-width-hairline) solid var(--color-accent);
    border-radius: var(--radius-sm);

    p:first-of-type {
      margin-top: 0;
    }

    /* Hide the return link - not needed for inline footnotes */
    [data-footnote-backref] {
      display: none;
    }
  }

  .inline-footnote-label,
  .inline-footnote-jump,
  .inline-footnote-close {
    color: var(--color-accent);
    &:hover {
      opacity: 0.7;
    }
  }

  .inline-footnote-label {
    font-size: var(--font-size-xs);
  }

  .inline-footnote-jump {
    text-decoration: none;
  }

  .inline-footnote-close {
    position: absolute;
    top: var(--space-xs);
    right: var(--space-xs);
    border: none;
    background: transparent;
    font-size: 1.2rem;
    line-height: 1;
    padding: 0;
  }
</style>

<script>
  function initInlineFootnotes() {
    document
      .querySelectorAll<HTMLAnchorElement>('a[data-footnote-ref]:not([data-inline-footnote-init])')
      .forEach(elm => {
        // Mark as initialized to avoid re-processing after view transitions
        elm.setAttribute('data-inline-footnote-init', '');

        const footnoteId = elm.getAttribute('href')?.slice(1);
        if (!footnoteId) return;
        const footnoteElement = document.getElementById(footnoteId);

        // Find the closest block-level parent (p, div, li, etc.)
        const closestBlock = elm.closest(
          'p, .intro-paragraph, li, blockquote, div.longform-prose > *'
        );
        if (!closestBlock || !footnoteElement?.children.length) return;

        const inlineFootNoteContainer = document.createElement('div');
        inlineFootNoteContainer.classList.add('inline-footnote-container');
        inlineFootNoteContainer.style.display = 'none';

        // Close button
        const closeBtn = document.createElement('button');
        closeBtn.classList.add('inline-footnote-close');
        closeBtn.innerHTML = '×';
        closeBtn.setAttribute('aria-label', 'Close footnote');
        closeBtn.addEventListener('click', () => {
          inlineFootNoteContainer.style.display = 'none';
        });

        inlineFootNoteContainer.appendChild(closeBtn);

        // Clone all child elements (supports multi-paragraph footnotes)
        for (const child of footnoteElement.children) {
          inlineFootNoteContainer.appendChild(child.cloneNode(true));
        }

        // Insert label and jump link inline within paragraph content
        const paragraphs = inlineFootNoteContainer.querySelectorAll('p');
        if (paragraphs.length) {
          const footnoteNum = elm.textContent || '';

          const label = document.createElement('span');
          label.className = 'inline-footnote-label';
          label.textContent = `${footnoteNum}. `;
          paragraphs[0].prepend(label);

          const jumpLink = document.createElement('a');
          jumpLink.className = 'inline-footnote-jump';
          jumpLink.href = `#${footnoteId}`;
          jumpLink.textContent = ' ↓';
          paragraphs[paragraphs.length - 1].append(jumpLink);
        }

        // Insert inside LI elements to preserve list structure, otherwise after the block
        if (closestBlock.tagName === 'LI') {
          closestBlock.appendChild(inlineFootNoteContainer);
        } else {
          closestBlock.insertAdjacentElement('afterend', inlineFootNoteContainer);
        }

        elm.addEventListener('click', e => {
          e.preventDefault();
          inlineFootNoteContainer.style.display =
            inlineFootNoteContainer.style.display === 'none' ? 'block' : 'none';
        });
      });
  }

  // Run on initial load
  initInlineFootnotes();

  // Re-run after Astro view transitions
  document.addEventListener('astro:page-load', initInlineFootnotes);
</script>
