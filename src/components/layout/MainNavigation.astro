---
import { Icon } from 'astro-icon/components';
import { NavLink, ThemeToggle } from '@components/navigation/index';
import { PersonalLogo } from '@components/ui/index';
const isDev = import.meta.env.MODE === 'development';
---

<button class="nav-open" type="button" aria-label="Open navigation" aria-expanded="false" aria-controls="main-navigation">
  <Icon name="heroicons:bars-3" />
</button>
<nav id="main-navigation" class="main-navigation ui-style dark-surface" inert>
  <button class="nav-close" type="button" aria-label="Close navigation">
    <Icon name="heroicons:x-mark" />
  </button>
  <PersonalLogo />
  <section class="nav-links all-caps">
    <ul class="list-reset">
      <li><NavLink href="/">Home</NavLink></li>
      <li><NavLink href="/writing">Writing</NavLink></li>
      <li><NavLink href="/notes">Notes</NavLink></li>
      <li><NavLink href="/now">Now</NavLink></li>
      <li><NavLink href="/working">Work <span class="external-arrow">↗</span></NavLink></li>
      <li><NavLink href="/toolbox">Toolbox <span class="external-arrow">↗</span></NavLink></li>
      {
        isDev && (
          <li>
            <NavLink href="/styleguide">Styleguide</NavLink>
          </li>
        )
      }
    </ul>
  </section>
  <div class="theme-toggle-wrapper">
    <ThemeToggle />
  </div>
</nav>

<style>
  .nav-open {
    position: absolute;
    top: var(--space-s);
    left: var(--space-s);
    aspect-ratio: 1;
    padding: var(--space-2xs);
    z-index: 1000;
    background: oklch(from var(--color-background-secondary) l c h / 0.8);
    color: var(--color-accent);
    border: none;
  }

  .main-navigation {
    position: fixed;
    left: -100%;
    min-width: 18rem; /* Wide enough for logo + close button */
    min-height: 100vh;
    z-index: 1000;
    border-right: var(--border-width-accent) solid var(--color-accent);
    padding: var(--space-s);
    transition: left var(--duration-normal) var(--ease-in-out);
  }

  .main-navigation.open {
    left: 0;
  }

  .nav-close {
    position: absolute;
    top: var(--space-2xs);
    right: var(--space-2xs);
    padding: var(--space-3xs);
    background: transparent;
    border: none;
  }

  .nav-links {
    margin-block: var(--space-m);
    padding-left: calc(var(--space-s) * 2);

    li {
      margin-top: var(--space-2xs);
    }

    a.active {
      color: var(--color-accent);
    }
  }

  .theme-toggle-wrapper {
    display: flex;
    justify-content: center;
  }
</style>

<script>
  const nav = document.querySelector<HTMLElement>('.main-navigation');
  const openBtn = document.querySelector<HTMLButtonElement>('.nav-open');
  const closeBtn = document.querySelector<HTMLButtonElement>('.nav-close');

  const closeNav = (returnFocus = false) => {
    nav?.classList.remove('open');
    nav?.setAttribute('inert', '');
    openBtn?.setAttribute('aria-expanded', 'false');
    if (returnFocus) openBtn?.focus();
  };

  const openNav = () => {
    nav?.classList.add('open');
    nav?.removeAttribute('inert');
    openBtn?.setAttribute('aria-expanded', 'true');
    closeBtn?.focus();
  };

  closeBtn?.addEventListener('click', () => closeNav(true));
  document.querySelector('main')?.addEventListener('click', () => closeNav());
  document.querySelector('footer')?.addEventListener('click', () => closeNav());
  openBtn?.addEventListener('click', openNav);

  // Close on Escape key
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && nav?.classList.contains('open')) {
      closeNav(true);
    }
  });
</script>
