---
interface Props {
  markdownUrl: string;
}

const { markdownUrl } = Astro.props;
---

<div class="markdown-actions">
  <a href="#" id="share-post" style="display: none;">share</a>
  <span id="share-separator" style="display: none;"> this post Â· </span>
  <a href="#" id="copy-markdown" data-url={markdownUrl}>copy</a>
  <span> / </span>
  <a href={markdownUrl} target="_blank">view</a>
  <span> as markdown</span>
</div>

<script>
  const copyLink = document.getElementById('copy-markdown');
  const shareLink = document.getElementById('share-post');
  const shareSeparator = document.getElementById('share-separator');

  async function copyMarkdown(url: string) {
    try {
      const response = await fetch(url);
      const markdown = await response.text();
      await navigator.clipboard.writeText(markdown);
      showFlashNotification('page copied as markdown to clipboard');
    } catch (err) {
      console.error('Failed to copy markdown:', err);
      alert('Failed to copy markdown to clipboard');
    }
  }

  async function sharePost() {
    try {
      await navigator.share({
        title: document.title,
        url: window.location.href,
      });
    } catch (err) {
      if (err instanceof Error && err.name !== 'AbortError') {
        console.error('Failed to share:', err);
      }
    }
  }

  function showFlashNotification(message: string) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.className = 'flash-notification';

    document.body.appendChild(notification);

    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease-out forwards';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }

  if ('share' in navigator && shareLink && shareSeparator) {
    shareLink.style.display = shareSeparator.style.display = 'inline';
    shareLink.addEventListener('click', (e) => {
      e.preventDefault();
      sharePost();
    });
  }

  if (copyLink) {
    copyLink.addEventListener('click', (e) => {
      e.preventDefault();
      const url = copyLink.getAttribute('data-url');
      if (url) copyMarkdown(url);
    });
  }
</script>

<style>
  .markdown-actions {
    margin-top: var(--space-l);
    color: var(--color-text-secondary);
  }

  /* Toast notification - injected via JS */
  :global(.flash-notification) {
    position: fixed;
    top: var(--space-s);
    right: var(--space-s);
    z-index: 9999;
    font-family: var(--font-ui);
    font-size: var(--font-size-sm);
    background-color: var(--color-accent);
    color: var(--color-white);
    padding: var(--space-2xs) var(--space-s);
    border-radius: var(--radius-sm);
    animation: slideIn var(--duration-slow) ease-out forwards;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slideOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }
</style>
