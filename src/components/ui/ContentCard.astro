---
import type { CollectionEntry } from 'astro:content';
import type { ImageMetadata } from 'astro';
import { Image } from 'astro:assets';
import { FormattedDate } from '@components/ui';
import { generateSummary } from '@utils/content-summary';

// Type configuration - easy to extend for new content types
const TYPE_CONFIG = {
  articles: {
    label: 'Article',
    color: 'var(--color-accent)',
    getUrl: (slug: string) => `/writing/${slug}/`,
  },
  notes: {
    label: 'Note',
    color: 'var(--color-blue)',
    getUrl: (slug: string) => `/notes/${slug}/`,
  },
  toolboxPages: {
    label: 'Tool',
    color: 'var(--color-green)',
    getUrl: (_slug: string, url: string) => url,
  },
} as const;

type ContentType = 'article' | 'note' | 'tool' | 'custom';

interface Props {
  /** Content collection entry - auto-extracts all data */
  content?: CollectionEntry<'articles'> | CollectionEntry<'notes'> | CollectionEntry<'toolboxPages'>;

  /** Manual props for custom/slot usage (when no content prop) */
  href?: string;
  title?: string;
  date?: Date;
  type?: ContentType;

  /** Force compact display regardless of container size */
  compact?: boolean;
}

const { content, compact = false, ...manualProps } = Astro.props;

// Derived state
let href: string;
let title: string;
let date: Date | undefined;
let summary: string | null = null;
let image: ImageMetadata | undefined;
let imageAlt: string | undefined;
let contentType: ContentType;
let typeLabel: string;
let borderColor: string;

if (content) {
  // Extract from content collection entry
  const { data, id, collection } = content;
  const config = TYPE_CONFIG[collection];

  title = data.title;
  typeLabel = config.label;
  borderColor = config.color;

  if (collection === 'toolboxPages') {
    href = config.getUrl('', data.url);
    contentType = 'tool';
  } else {
    const slug = data.slug || id.replace(/\.(md|mdx)$/, '');
    href = config.getUrl(slug, '');
    date = data.pubDate;
    image = 'cover' in data ? data.cover : undefined;
    imageAlt = 'coverAlt' in data ? data.coverAlt : undefined;
    summary = generateSummary(content, 200);
    contentType = collection === 'articles' ? 'article' : 'note';
  }
} else {
  // Use manual props
  href = manualProps.href || '#';
  title = manualProps.title || '';
  date = manualProps.date;
  contentType = manualProps.type || 'custom';
  typeLabel = contentType.charAt(0).toUpperCase() + contentType.slice(1);
  borderColor = 'var(--color-accent)';
}

const hasSlot = Astro.slots.has('default');
---

<article
  class:list={['content-card', 'ui-style', 'cq', { compact }]}
  data-type={contentType}
  style={`--_border-color: ${borderColor}`}
>
  <a href={href} class="card-link">
    {image && (
      <div class="card-image">
        <Image
          src={image}
          alt={imageAlt || `Cover for ${title}`}
          width={400}
          height={200}
          loading="lazy"
        />
      </div>
    )}

    <div class="card-content">
      <header class="card-header">
        <div class="card-meta">
          <span class="type-label">{typeLabel}</span>
          {date && (
            <time class="date" datetime={date.toISOString()}>
              <FormattedDate date={date} />
            </time>
          )}
        </div>
        <h2 class="card-title">{title}</h2>
      </header>

      {hasSlot ? (
        <div class="card-body">
          <slot />
        </div>
      ) : (
        summary && <p class="card-summary">{summary}</p>
      )}
    </div>
  </a>
</article>

<style>
  /* Component-scoped transitioning color - enables smooth interpolation */
  @property --_border-color {
    syntax: '<color>';
    inherits: false;
    initial-value: oklch(70% 0.18 25);
  }

  /* Container query applied via .cq class */
  .content-card {
    --_border-color: var(--color-accent);

    position: relative;
    background: var(--surface-raised);
    filter: var(--shadow-small);
    overflow: hidden;
    transition: filter var(--duration-fast) var(--ease-in-out);

    /* Left border as pseudo-element - grows on hover without shifting content */
    &::before {
      content: '';
      position: absolute;
      inset-block: 0;
      left: 0;
      width: var(--border-width-thick);
      background: var(--_border-color);
      transition: width var(--duration-fast) var(--ease-in-out);
      z-index: 1;
    }

    &:hover {
      filter: var(--shadow-medium);
    }

    &:hover::before {
      width: var(--border-width-heavy);
    }

    /* Compact mode - forced via prop */
    &.compact {
      & :is(.card-image, .card-summary, .card-body) {
        display: none;
      }

      & .card-content {
        padding: var(--space-xs);
      }

      & .card-title {
        font-size: var(--font-size-base);
      }
    }
  }

  .card-link {
    display: block;
    height: 100%;

    &:focus-visible {
      outline: var(--border-width-base) solid var(--color-accent);
      outline-offset: 2px;
    }
  }

  .card-image {
    width: 100%;
    aspect-ratio: 2 / 1;
    max-height: 200px;
    overflow: hidden;

    & img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      object-position: center;
    }
  }

  .card-content {
    padding: var(--space-s);
  }

  .card-meta {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: baseline;
    gap: var(--space-2xs);
    margin-bottom: var(--space-2xs);
    font-size: var(--font-size-xs);
    color: var(--color-text-secondary);
  }

  .type-label {
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
    font-weight: var(--font-weight-medium);
  }

  .card-title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-bold);
    line-height: var(--leading-snug);
  }

  .card-summary,
  .card-body {
    margin-top: var(--space-xs);
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    line-height: var(--leading-normal);
  }

  /* Container query - responsive compactness */
  @container (width < 350px) {
    :is(.card-image, .card-summary, .card-body) {
      display: none;
    }

    .card-content {
      padding: var(--space-xs);
    }

    .card-title {
      font-size: var(--font-size-sm);
    }
  }
</style>
