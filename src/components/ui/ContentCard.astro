---
import type { CollectionEntry } from 'astro:content';
import { Image } from 'astro:assets';
import { FormattedDate } from '@components/ui';
import { generateSummary } from '@utils/content-summary';

export interface Props {
  content: CollectionEntry<'articles'> | CollectionEntry<'notes'> | CollectionEntry<'toolboxPages'>;
  variant?: 'compact' | 'standard';
  showSummary?: boolean;
  summaryLength?: number;
}

const { 
  content, 
  variant = 'standard', 
  showSummary = true, 
  summaryLength = 200 
} = Astro.props;

const { data, id, collection } = content;

// Handle different content types
let title: string;
let pubDate: Date | undefined;
let cover: any = undefined;
let coverAlt: string | undefined = undefined;
let contentUrl: string;
let summary: string | null = null;
let contentType: string;
let typeLabel: string;
let typeIcon: string;

if (collection === 'toolboxPages') {
  title = data.title;
  contentUrl = data.url;
  contentType = 'toolbox';
  typeLabel = 'Tool';
  typeIcon = 'üîß';
} else {
  // Articles and notes
  title = data.title;
  pubDate = data.pubDate;
  cover = 'cover' in data ? data.cover : undefined;
  coverAlt = 'coverAlt' in data ? data.coverAlt : undefined;
  
  const slug = data.slug || id.replace(/\.(md|mdx)$/, '');
  contentUrl = collection === 'articles' ? `/writing/${slug}/` : `/notes/${slug}/`;

  summary = showSummary ? generateSummary(content, summaryLength) : null;
  contentType = collection === 'articles' ? 'article' : 'note';
  typeLabel = collection === 'articles' ? 'Article' : 'Note';
  typeIcon = collection === 'articles' ? 'üìñ' : 'üìù';
}
---

<article class={`content-card cq ${variant}`} data-type={contentType}>
  <a href={contentUrl} class="card-link">
    {cover && variant !== 'compact' && (
      <div class="card-image">
        <Image 
          src={cover} 
          alt={coverAlt || `Cover for ${title}`}
          width={400}
          height={200}
          loading="lazy"
        />
      </div>
    )}

    <div class="card-content">
      <header class="card-header">
        <div class="card-meta">
          <span class="content-type">
            <span class="type-icon" aria-hidden="true">{typeIcon}</span>
            <span class="type-label">{typeLabel}</span>
          </span>
          {pubDate && (
            <time class="date" datetime={pubDate.toISOString()}>
              <FormattedDate date={pubDate} />
            </time>
          )}
        </div>
        <h2 class="card-title">{title}</h2>
      </header>

      {summary && (
        <div class="card-summary">
          <p>{summary}</p>
        </div>
      )}
    </div>
  </a>
</article>

<style>
  .content-card {
    container-type: inline-size;
    background: var(--color-contentcard-bg);
    border: none;
    border-radius: 0;
    border-left: var(--border-width-thick) solid var(--color-contentcard-article-accent);
    filter: var(--elevation-low);
    transition: all var(--duration-fast) var(--ease-default);
    overflow: hidden;
  }

  .content-card[data-type="note"] {
    border-left-color: var(--color-contentcard-note-accent);
  }

  .content-card[data-type="toolbox"] {
    border-left-color: var(--color-contentcard-toolbox-accent);
  }

  .content-card:hover {
    border-left-width: var(--border-width-heavy);
    background: var(--color-bg-secondary);
    filter: var(--elevation-medium);
  }

  .card-link {
    display: block;
    text-decoration: none;
    color: inherit;
    height: 100%;
  }

  .card-image {
    width: 100%;
    height: 160px;
    overflow: hidden;
  }

  .card-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .card-content {
    padding: var(--space-4);
  }

  .card-header {
    margin-bottom: var(--space-3);
  }

  .card-meta {
    display: flex;
    flex-wrap: wrap; /* Defensive: allow wrapping */
    justify-content: space-between;
    align-items: center;
    gap: var(--space-2);
    margin-bottom: var(--space-2);
    font-size: var(--font-size-xs);
    opacity: 0.7;
  }

  .content-type {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    font-weight: var(--font-weight-semibold);
  }

  .type-icon {
    display: none;
  }

  .type-label {
    text-transform: uppercase;
    letter-spacing: var(--tracking-wide);
    font-size: var(--font-size-xs);
  }

  .date {
    font-size: var(--font-size-xs);
    font-weight: var(--font-weight-regular);
  }

  .card-title {
    font-size: var(--font-size-md);
    font-weight: var(--font-weight-bold);
    line-height: var(--leading-snug);
    margin: 0;
    color: var(--color-text-primary);
    overflow-wrap: break-word; /* Defensive: handle long titles */
  }

  .card-summary {
    margin-bottom: var(--space-3);
  }

  .card-summary p {
    margin: 0;
    color: var(--color-text-secondary);
    line-height: var(--leading-normal);
    font-size: var(--font-size-sm);
  }



  /* Compact variant */
  .content-card.compact .card-summary {
    display: none;
  }

  .content-card.compact .card-content {
    padding: var(--space-3);
  }

  .content-card.compact .card-title {
    font-size: var(--font-size-base);
  }

  /* Container queries for responsive behavior */
  @container (width < 300px) {
    .card-summary {
      display: none;
    }

    .card-image {
      display: none;
    }

    .card-content {
      padding: var(--space-3);
    }

    .card-title {
      font-size: var(--font-size-sm);
    }
  }


  /* Focus and accessibility */
  .card-link:focus {
    outline: var(--border-width-base) solid var(--color-accent);
    outline-offset: var(--space-1);
  }

  .card-link:focus-visible {
    outline: var(--border-width-base) solid var(--color-accent);
    outline-offset: var(--space-1);
  }
</disabled-style>