---
import { Icon } from 'astro-icon/components';

export interface Props {
  class?: string;
}

const options = [
  { value: 'light', description: 'Use light theme', icon: 'heroicons:sun' },
  { value: 'auto', description: 'Follow system theme', icon: 'heroicons:computer-desktop' },
  { value: 'dark', description: 'Use dark theme', icon: 'heroicons:moon' },
] as const;

const { class: className } = Astro.props;
---

<div class:list={['theme-toggle', className]} role="radiogroup" aria-label="Choose color theme">
  {options.map(option => (
    <button
      type="button"
      role="radio"
      aria-checked={option.value === 'auto' ? 'true' : 'false'}
      data-theme-option={option.value}
      title={option.description}
    >
      <span class="sr-only">{option.description}</span>
      <Icon name={option.icon} aria-hidden="true" />
    </button>
  ))}
</div>

<style>
  .theme-toggle {
    --_size: var(--theme-toggle-thumb-size, clamp(1.75rem, 4vw, 2.25rem));
    --_pad: var(--theme-toggle-padding, var(--space-3xs));
    --_gap: var(--theme-toggle-gap, var(--space-3xs));
    --_pos: 1; /* 0=light, 1=auto, 2=dark */

    display: inline-grid;
    grid-template-columns: repeat(3, var(--_size));
    gap: var(--_gap);
    padding: var(--_pad);
    position: relative;
    border-radius: var(--radius-full);
    border: var(--border-width-hairline) solid color-mix(in oklch, var(--color-text) 12%, transparent);
    background: color-mix(in oklch, var(--color-background) 80%, var(--color-background-secondary));

    /* Thumb */
    &::before {
      content: '';
      position: absolute;
      inset-block: var(--_pad);
      width: var(--_size);
      border-radius: var(--radius-full);
      background: var(--_thumb-bg, color-mix(in oklch, var(--color-text) 10%, var(--color-background-secondary)));
      translate: calc(var(--_pad) + (var(--_size) + var(--_gap)) * var(--_pos)) 0;
      transition: translate var(--duration-fast) var(--ease-in-out);
      pointer-events: none;
    }

    &:has([data-theme-option='light'][aria-checked='true']) {
      --_pos: 0;
      --_thumb-bg: color-mix(in oklch, var(--color-accent) 45%, var(--color-background));
    }

    &:has([data-theme-option='dark'][aria-checked='true']) {
      --_pos: 2;
      --_thumb-bg: color-mix(in oklch, var(--color-accent) 25%, var(--color-background));
    }

    /* Buttons */
    & button {
      display: grid;
      place-items: center;
      aspect-ratio: 1;
      padding: 0;
      border: 0;
      border-radius: var(--radius-full);
      background: transparent;
      color: color-mix(in oklch, var(--color-text) 40%, transparent);
      cursor: pointer;
      z-index: 1;
      transition: color var(--duration-fast) var(--ease-in-out);

      &[aria-checked='true'] { color: var(--color-text); }
      &:hover { color: color-mix(in oklch, var(--color-text) 70%, transparent); }
      &:focus-visible {
        outline: var(--border-width-base) solid color-mix(in oklch, var(--color-accent) 65%, transparent);
        outline-offset: 2px;
      }
    }

    & svg { width: 1.25em; height: 1.25em; }

    @media (prefers-reduced-motion: reduce) {
      &::before { transition: none; }
    }
  }
</style>

<script>
  function initThemeToggle() {
    const toggle = document.querySelector<HTMLElement>('.theme-toggle');
    if (!toggle) return;

    // Set initial state
    const current = window.theme?.current ?? 'auto';
    updateChecked(toggle, current);

    // Handle clicks via event delegation
    toggle.addEventListener('click', (e) => {
      const button = (e.target as HTMLElement).closest<HTMLButtonElement>('[data-theme-option]');
      if (!button) return;
      const choice = button.dataset.themeOption as 'light' | 'dark' | 'auto';
      window.theme?.set(choice);
    });
  }

  function updateChecked(toggle: HTMLElement, theme: string) {
    toggle.querySelectorAll<HTMLButtonElement>('[data-theme-option]').forEach(btn => {
      btn.setAttribute('aria-checked', btn.dataset.themeOption === theme ? 'true' : 'false');
    });
  }

  // Listen for theme changes from external sources
  document.addEventListener('theme-changed', (e: CustomEvent) => {
    const toggle = document.querySelector<HTMLElement>('.theme-toggle');
    if (toggle) updateChecked(toggle, e.detail?.theme ?? 'auto');
  });

  // Initialize on page load and Astro navigation
  document.addEventListener('DOMContentLoaded', initThemeToggle);
  document.addEventListener('astro:after-swap', initThemeToggle);
</script>
