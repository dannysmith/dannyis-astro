---
import { Icon } from 'astro-icon/components';

export interface Props {
  class?: string;
}

const options = [
  { value: 'light', description: 'Use light theme', icon: 'heroicons:sun' },
  { value: 'auto', description: 'Follow system theme', icon: 'heroicons:computer-desktop' },
  { value: 'dark', description: 'Use dark theme', icon: 'heroicons:moon' },
] as const;

const { class: className } = Astro.props;
---

<div class:list={['theme-toggle', className]} role="radiogroup" aria-label="Choose color theme">
  {options.map(option => (
    <button
      type="button"
      role="radio"
      aria-checked={option.value === 'auto' ? 'true' : 'false'}
      data-theme-option={option.value}
      title={option.description}
    >
      <span class="sr-only">{option.description}</span>
      <Icon name={option.icon} aria-hidden="true" />
    </button>
  ))}
</div>

<style>
  /* Component-scoped transitioning color - enables smooth thumb color transitions */
  @property --_thumb-bg {
    syntax: '<color>';
    inherits: false;
    initial-value: transparent;
  }

  /*
   * Theme Toggle
   * A 3-option segmented control (light/auto/dark) with a sliding thumb indicator.
   *
   * How it works:
   * - CSS Grid creates 3 equal columns for the buttons
   * - A ::before pseudo-element acts as the sliding thumb
   * - :has() detects which button is checked and sets --_pos (0, 1, or 2)
   * - The thumb position is calculated: padding + (size + gap) × position
   * - JS only manages aria-checked state; CSS handles all visual positioning
   *
   * Customize with: --theme-toggle-thumb-size, --theme-toggle-padding, --theme-toggle-gap
   */
  .theme-toggle {
    /* Configurable dimensions (override these externally if needed) */
    --_size: var(--theme-toggle-thumb-size, clamp(1.75rem, 4vw, 2.25rem));
    --_pad: var(--theme-toggle-padding, var(--space-3xs));
    --_gap: var(--theme-toggle-gap, var(--space-3xs));

    /* Position index: 0=light, 1=auto (default), 2=dark */
    --_pos: 1;

    display: inline-grid;
    grid-template-columns: repeat(3, var(--_size));
    gap: var(--_gap);
    padding: var(--_pad);
    position: relative;
    border-radius: var(--radius-full);
    border: var(--border-width-hairline) solid color-mix(in oklch, var(--color-text) 12%, transparent);
    background: color-mix(in oklch, var(--color-background) 80%, var(--color-background-secondary));

    /* Sliding thumb indicator */
    &::before {
      content: '';
      position: absolute;
      inset-block: var(--_pad);
      width: var(--_size);
      border-radius: var(--radius-full);
      pointer-events: none;
      /* Position formula: offset from left = padding + (cell width × index) */
      translate: calc(var(--_pad) + (var(--_size) + var(--_gap)) * var(--_pos)) 0;
      /* Thumb color: neutral by default, accent-tinted when light/dark selected */
      background: var(--_thumb-bg, color-mix(in oklch, var(--color-text) 10%, var(--color-background-secondary)));
      transition: translate var(--duration-fast) var(--ease-in-out);
    }

    /* State detection via :has() - sets position index and thumb color */
    &:has([data-theme-option='light'][aria-checked='true']) {
      --_pos: 0;
      --_thumb-bg: color-mix(in oklch, var(--color-accent) 45%, var(--color-background));
    }

    &:has([data-theme-option='dark'][aria-checked='true']) {
      --_pos: 2;
      --_thumb-bg: color-mix(in oklch, var(--color-accent) 25%, var(--color-background));
    }

    /* Option buttons */
    & button {
      display: grid;
      place-items: center;
      aspect-ratio: 1;
      padding: 0;
      border: 0;
      border-radius: var(--radius-full);
      background: transparent;
      color: color-mix(in oklch, var(--color-text) 40%, transparent);
      cursor: pointer;
      z-index: 1; /* Above the thumb */
      transition: color var(--duration-fast) var(--ease-in-out);

      &[aria-checked='true'] { color: var(--color-text); }
      &:hover { color: color-mix(in oklch, var(--color-text) 70%, transparent); }
      &:focus-visible {
        outline: var(--border-width-base) solid color-mix(in oklch, var(--color-accent) 65%, transparent);
        outline-offset: 2px;
      }
    }

    & svg { width: 1.25em; height: 1.25em; }

    @media (prefers-reduced-motion: reduce) {
      &::before { transition: none; }
    }
  }
</style>

<script>
  /*
   * Theme Toggle JS
   * Minimal - only manages aria-checked state. CSS handles all visuals via :has().
   * Relies on window.theme API (from theme script in <head>) for persistence.
   */
  function initThemeToggle() {
    const toggle = document.querySelector<HTMLElement>('.theme-toggle');
    if (!toggle) return;

    updateChecked(toggle, window.theme?.current ?? 'auto');

    // Event delegation: single click listener for all option buttons
    toggle.addEventListener('click', (e) => {
      const button = (e.target as HTMLElement).closest<HTMLButtonElement>('[data-theme-option]');
      if (button) window.theme?.set(button.dataset.themeOption as 'light' | 'dark' | 'auto');
    });
  }

  function updateChecked(toggle: HTMLElement, theme: string) {
    toggle.querySelectorAll<HTMLButtonElement>('[data-theme-option]').forEach(btn => {
      btn.setAttribute('aria-checked', btn.dataset.themeOption === theme ? 'true' : 'false');
    });
  }

  // Sync with external theme changes (e.g., other toggles or system preference changes)
  document.addEventListener('theme-changed', (e: CustomEvent) => {
    const toggle = document.querySelector<HTMLElement>('.theme-toggle');
    if (toggle) updateChecked(toggle, e.detail?.theme ?? 'auto');
  });

  // Initialize on page load and after Astro view transitions
  document.addEventListener('DOMContentLoaded', initThemeToggle);
  document.addEventListener('astro:after-swap', initThemeToggle);
</script>
