---
import { Icon } from 'astro-icon/components';

export interface Props {
  class?: string;
}

const options = [
  { value: 'light', description: 'Use light theme', icon: 'heroicons:sun' },
  { value: 'auto', description: 'Follow system theme', icon: 'heroicons:computer-desktop' },
  { value: 'dark', description: 'Use dark theme', icon: 'heroicons:moon' },
] as const;

const { class: className } = Astro.props;
---

<div class:list={['theme-toggle', className]} role="radiogroup" aria-label="Choose color theme">
  {options.map(option => (
    <button
      type="button"
      role="radio"
      aria-checked={option.value === 'auto' ? 'true' : 'false'}
      data-theme-option={option.value}
      title={option.description}
    >
      <span class="sr-only">{option.description}</span>
      <Icon name={option.icon} aria-hidden="true" />
    </button>
  ))}
</div>

<style>
  .theme-toggle {
    /* Configurable sizing */
    --_thumb-size: var(--theme-toggle-thumb-size, clamp(1.75rem, 4vw, 2.25rem));
    --_padding: var(--theme-toggle-padding, var(--space-3xs));
    --_gap: var(--theme-toggle-gap, var(--space-3xs));

    /* Internal colors - adapt to theme */
    --_track-bg: color-mix(in oklch, var(--color-background) 80%, var(--color-background-secondary));
    --_border: color-mix(in oklch, var(--color-text) 12%, transparent);
    --_icon-muted: color-mix(in oklch, var(--color-text) 40%, transparent);
    --_icon-active: var(--color-text);

    /* Layout */
    display: inline-grid;
    grid-template-columns: repeat(3, var(--_thumb-size));
    gap: var(--_gap);
    padding: var(--_padding);

    /* Appearance */
    border-radius: var(--radius-full);
    border: var(--border-width-hairline) solid var(--_border);
    background: var(--_track-bg);

    /* Establish positioning context for thumb */
    position: relative;
  }

  /* Thumb - positioned via :has() detecting checked state */
  .theme-toggle::before {
    content: '';
    position: absolute;
    inset-block: var(--_padding);
    width: var(--_thumb-size);
    border-radius: var(--radius-full);
    background: color-mix(in oklch, var(--color-text) 10%, var(--color-background-secondary));
    pointer-events: none;
    transition: translate var(--duration-fast) var(--ease-in-out);

    /* Default: middle position (auto) */
    translate: calc(var(--_thumb-size) + var(--_gap) + var(--_padding)) 0;
  }

  /* Thumb position based on checked state */
  .theme-toggle:has([data-theme-option='light'][aria-checked='true'])::before {
    translate: var(--_padding) 0;
    background: color-mix(in oklch, var(--color-accent) 45%, var(--color-background));
  }

  .theme-toggle:has([data-theme-option='dark'][aria-checked='true'])::before {
    translate: calc((var(--_thumb-size) + var(--_gap)) * 2 + var(--_padding)) 0;
    background: color-mix(in oklch, var(--color-accent) 25%, var(--color-background));
  }

  /* Buttons */
  .theme-toggle button {
    display: grid;
    place-items: center;
    width: var(--_thumb-size);
    height: var(--_thumb-size);
    padding: 0;
    border: 0;
    border-radius: var(--radius-full);
    background: transparent;
    color: var(--_icon-muted);
    cursor: pointer;
    position: relative;
    z-index: 1;
    transition: color var(--duration-fast) var(--ease-in-out);
  }

  .theme-toggle button[aria-checked='true'] {
    color: var(--_icon-active);
  }

  .theme-toggle button:hover {
    color: color-mix(in oklch, var(--color-text) 70%, transparent);
  }

  .theme-toggle button:focus-visible {
    outline: var(--border-width-base) solid color-mix(in oklch, var(--color-accent) 65%, transparent);
    outline-offset: 2px;
  }

  .theme-toggle svg {
    width: 1.25em;
    height: 1.25em;
  }

  @media (prefers-reduced-motion: reduce) {
    .theme-toggle::before {
      transition: none;
    }
  }
</style>

<script>
  function initThemeToggle() {
    const toggle = document.querySelector<HTMLElement>('.theme-toggle');
    if (!toggle) return;

    // Set initial state
    const current = window.theme?.current ?? 'auto';
    updateChecked(toggle, current);

    // Handle clicks via event delegation
    toggle.addEventListener('click', (e) => {
      const button = (e.target as HTMLElement).closest<HTMLButtonElement>('[data-theme-option]');
      if (!button) return;
      const choice = button.dataset.themeOption as 'light' | 'dark' | 'auto';
      window.theme?.set(choice);
    });
  }

  function updateChecked(toggle: HTMLElement, theme: string) {
    toggle.querySelectorAll<HTMLButtonElement>('[data-theme-option]').forEach(btn => {
      btn.setAttribute('aria-checked', btn.dataset.themeOption === theme ? 'true' : 'false');
    });
  }

  // Listen for theme changes from external sources
  document.addEventListener('theme-changed', (e: CustomEvent) => {
    const toggle = document.querySelector<HTMLElement>('.theme-toggle');
    if (toggle) updateChecked(toggle, e.detail?.theme ?? 'auto');
  });

  // Initialize on page load and Astro navigation
  document.addEventListener('DOMContentLoaded', initThemeToggle);
  document.addEventListener('astro:after-swap', initThemeToggle);
</script>
