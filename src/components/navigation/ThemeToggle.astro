---
import { Icon } from 'astro-icon/components';

export interface Props {
  class?: string;
}

const options = [
  {
    value: 'light',
    label: 'Light',
    description: 'Use light theme',
    icon: 'heroicons:sun',
  },
  {
    value: 'auto',
    label: 'System',
    description: 'Follow system theme',
    icon: 'heroicons:computer-desktop',
  },
  {
    value: 'dark',
    label: 'Dark',
    description: 'Use dark theme',
    icon: 'heroicons:moon',
  },
] as const;

const { class: className = '' } = Astro.props;
const rootClass = ['theme-toggle', className].filter(Boolean).join(' ').trim();
---

<div class={rootClass} data-theme-toggle data-theme-current="auto" role="radiogroup" aria-label="Choose color theme">
  <span class="theme-toggle__thumb" aria-hidden="true"></span>
  {options.map(option => (
    <button
      type="button"
      role="radio"
      aria-checked="false"
      data-theme-option={option.value}
      title={option.description}
    >
      <span class="sr-only">{option.description}</span>
      <Icon name={option.icon} aria-hidden="true" />
    </button>
  ))}
</div>

<style>
  .theme-toggle[data-theme-toggle] {
    --theme-count: 3;
    --theme-index: 0;
    --theme-thumb-size: clamp(1.9rem, var(--space-m), 2.25rem);
    --theme-track-padding-block: var(--space-4xs);
    --theme-track-padding-inline: var(--space-2xs);
    --theme-track-height: calc(var(--theme-thumb-size) + var(--theme-track-padding-block) * 2);
    --theme-step: calc(
      (100% - (var(--theme-track-padding-inline) * 2) - var(--theme-thumb-size)) / (var(--theme-count) - 1)
    );
    --theme-thumb-color: color-mix(in oklch, var(--color-accent) 45%, var(--color-background));
    position: relative;
    display: inline-flex;
    align-items: center;
    width: clamp(10rem, 22vw, 13rem);
    min-height: var(--theme-track-height);
    padding: var(--theme-track-padding-block) var(--theme-track-padding-inline);
    border-radius: var(--radius-full);
    border: var(--border-width-hairline) solid color-mix(in oklch, var(--color-text) 12%, transparent);
    background: color-mix(in oklch, var(--color-background) 70%, var(--color-background-secondary) 30%);
    color: var(--color-text);
  }

  .theme-toggle__thumb {
    position: absolute;
    top: var(--theme-track-padding-block);
    left: calc(var(--theme-track-padding-inline) + var(--theme-step) * var(--theme-index));
    width: var(--theme-thumb-size);
    height: var(--theme-thumb-size);
    border-radius: var(--radius-full);
    background: var(--theme-thumb-color);
    pointer-events: none;
    transition:
      left var(--duration-fast) var(--ease-in-out),
      background var(--duration-fast) var(--ease-in-out);
  }

  .theme-toggle[data-theme-toggle] button {
    flex: 1;
    height: var(--theme-track-height);
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-3xs);
    border: 0;
    background: transparent;
    color: color-mix(in oklch, var(--color-text) 45%, var(--color-background));
    cursor: pointer;
    border-radius: var(--radius-full);
    position: relative;
    z-index: 1;
    transition: color var(--duration-fast) var(--ease-in-out);
  }

  .theme-toggle[data-theme-toggle] button[aria-checked='true'] {
    color: var(--color-text);
  }

  .theme-toggle[data-theme-toggle] button:hover {
    color: color-mix(in oklch, var(--color-text) 65%, var(--color-background));
  }

  .theme-toggle[data-theme-toggle] button:focus-visible {
    outline: var(--border-width-base) solid color-mix(in oklch, var(--color-accent) 65%, transparent);
    outline-offset: var(--space-3xs);
  }

  .theme-toggle[data-theme-toggle] svg {
    width: var(--space-s);
    height: var(--space-s);
  }

  .theme-toggle[data-theme-current='light'] {
    --theme-thumb-color: color-mix(in oklch, var(--color-accent) 45%, var(--color-background));
  }

  .theme-toggle[data-theme-current='auto'] {
    --theme-thumb-color: color-mix(in oklch, var(--color-text) 10%, var(--color-background-secondary) 80%);
  }

  .theme-toggle[data-theme-current='dark'] {
    --theme-thumb-color: color-mix(in oklch, var(--color-accent) 25%, var(--color-background));
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (prefers-reduced-motion: reduce) {
    .theme-toggle__thumb,
    .theme-toggle[data-theme-toggle] button {
      transition: none;
    }
  }
</style>

<script>
  const themeOrder = ['light', 'auto', 'dark'];
  let toggle: HTMLElement | null = null;
  let buttons: HTMLButtonElement[] = [];
  let systemPreference: MediaQueryList | null = null;

  function applyThemeState(theme) {
    if (!toggle) return;
    const index = Math.max(0, themeOrder.indexOf(theme));
    toggle.style.setProperty('--theme-index', String(index));
    toggle.dataset.themeCurrent = theme;
    buttons.forEach(button => {
      button.setAttribute('aria-checked', button.dataset.themeOption === theme ? 'true' : 'false');
    });
  }

  function bindToggle() {
    toggle = document.querySelector('[data-theme-toggle]');
    if (!toggle) return;
    buttons = Array.from(toggle.querySelectorAll('[data-theme-option]')) as HTMLButtonElement[];
    buttons.forEach(button => {
      button.addEventListener('click', () => {
        const choice = button.dataset.themeOption;
        if (!choice || !window.theme) return;
        window.theme.set(choice as 'light' | 'dark' | 'auto');
      });
    });
    applyThemeState(window.theme?.current ?? 'auto');

    if (!systemPreference) {
      systemPreference = window.matchMedia('(prefers-color-scheme: dark)');
      systemPreference.addEventListener('change', () => {
        if (window.theme?.current === 'auto') {
          applyThemeState('auto');
        }
      });
    }
  }

  document.addEventListener('theme-changed', event => {
    const nextTheme = event.detail?.theme ?? window.theme?.current ?? 'auto';
    applyThemeState(nextTheme);
  });

  document.addEventListener('DOMContentLoaded', () => {
    bindToggle();
    applyThemeState(window.theme?.current ?? 'auto');
  });

  document.addEventListener('astro:after-swap', () => {
    bindToggle();
    applyThemeState(window.theme?.current ?? 'auto');
  });
</script>
