---
import type { CollectionEntry } from 'astro:content';
import type { MarkdownHeading } from 'astro';
import { Image } from 'astro:assets';
import Spinner from '@components/ui/Spinner.astro';
import BaseHead from '@components/layout/BaseHead.astro';
import Footer from '@components/layout/Footer.astro';
import FormattedDate from '@components/ui/FormattedDate.astro';
import Lightbox from '@components/layout/Lightbox.astro';
import MainNavigation from '@components/layout/MainNavigation.astro';
import LongFormProseTypography from '@components/layout/LongFormProseTypography.astro';
import MarkdownContentActions from '@components/ui/MarkdownContentActions.astro';
import TableOfContents from '@components/layout/TableOfContents.astro';

type Props = CollectionEntry<'articles'>['data'] & {
  readingTime: string;
  headings: MarkdownHeading[];
};
const {
  title,
  description,
  pubDate,
  updatedDate,
  cover,
  coverAlt,
  draft,
  redirectURL,
  platform,
  readingTime,
  headings,
} = Astro.props;

// Build OG image path for this article
const ogImage = `/writing/${Astro.params.slug}/og-image.png`;
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead
      title={title}
      description={description}
      type="article"
      pageType="article"
      image={ogImage}
    />
    {platform && redirectURL && <meta http-equiv="refresh" content={'0;url=' + redirectURL} />}
  </head>

  <body>
    <MainNavigation />
    {
      platform && redirectURL && (
        <div class="spinner-overlay">
          <Spinner size="5rem" />
        </div>
      )
    }
    <main>
      <article class="h-entry" itemscope itemtype="https://schema.org/Article">
        <TableOfContents headings={headings} />
        <LongFormProseTypography>
          {
            cover && coverAlt && (
              <div class="hero-image">
                <Image
                  src={cover}
                  alt={coverAlt}
                  layout="constrained"
                  width={1200}
                  height={240}
                  quality={85}
                  format="webp"
                />
              </div>
            )
          }
          <div class="post-header">
            <div class="metadata">
              <FormattedDate date={pubDate} itemprop="datePublished" />
              {
                updatedDate && (
                  <span class="last-updated-on">
                    (updated <FormattedDate date={updatedDate} itemprop="dateModified" />)
                  </span>
                )
              }
              {readingTime && <span class="reading-time">Â· {readingTime}</span>}
              {draft && <span class="draft-notice">ðŸš§ Draft</span>}
            </div>

            <h1 class="title p-name" itemprop="headline">{title}</h1>
          </div>
          <slot />
          <MarkdownContentActions markdownUrl={`${Astro.url.pathname.replace(/\/$/, '')}.md`} />
        </LongFormProseTypography>
      </article>
    </main>

    <Footer />
    <Lightbox />
    <style>
      /* Article needs position context for TOC */
      article {
        position: relative;
      }

      /* Article grid layout - 3 columns for full-bleed support */
      :global(.longform-prose) {
        --gutter: var(--space-m);
        display: grid;
        grid-template-columns:
          minmax(var(--gutter), 1fr)
          min(60ch, calc(100% - var(--gutter) * 2))
          minmax(var(--gutter), 1fr);
      }

      /* All other elements span the middle column */
      :global(.longform-prose) > :global(*) {
        grid-column: 2 / 3;
      }

      /* Full-bleed elements span all columns */
      :global(.longform-prose) > :global(.full-bleed),
      .hero-image {
        grid-column: 1 / -1;
      }

      .spinner-overlay {
        min-height: 100vh;
        display: grid;
        place-content: center;
        background: var(--color-background);
      }

      .metadata {
        font-size: var(--font-size-sm);
        color: var(--color-accent);
        font-family: var(--font-code);
        margin-top: var(--space-s);
      }

      @media (max-width: 700px) {
        .metadata {
          padding-top: var(--space-l);
        }
      }

      .hero-image {
        aspect-ratio: 5 / 1;
        overflow: hidden;
      }

      .hero-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        filter: light-dark(none, grayscale(70%));
      }

      .draft-notice {
        border: var(--border-width-base) solid var(--color-accent);
        color: var(--color-accent);
        font-family: var(--font-ui);
        padding: var(--space-2xs) var(--space-s);
        border-radius: var(--radius-sm);
        float: right;
      }

      /* Inline footnotes - toggled by JS below */
      /* Use :global() so styles apply to dynamically created elements */
      :global(.inline-footnote-container) {
        font-size: var(--font-size-sm);
        padding: var(--space-s);
        margin-top: var(--space-xs);
        position: relative;

        /* Hide the return link - not needed for inline footnotes */
        [data-footnote-backref] {
          display: none;
        }
      }

      :global(.inline-footnote-close) {
        position: absolute;
        top: var(--space-2xs);
        right: var(--space-2xs);
        border: none;
        background: transparent;
        color: var(--color-text-secondary);
        font-size: 1.2rem;
        line-height: 1;
        padding: 0.25rem;
        opacity: 0.6;
        transition: opacity var(--duration-fast);

        &:hover {
          opacity: 1;
        }
      }
    </style>

    <script>
      document.querySelectorAll('a[data-footnote-ref]').forEach(el => {
        const elm = el as HTMLAnchorElement;
        const footnoteId = elm.getAttribute('href')?.slice(1);
        if (!footnoteId) return;
        const footnoteElement = document.getElementById(footnoteId);

        // Find the closest block-level parent (p, div, li, etc.)
        const closestBlock = elm.closest(
          'p, .intro-paragraph, li, blockquote, div.longform-prose > *'
        );
        if (!closestBlock || !footnoteElement?.firstElementChild) return;

        const inlineFootNoteContainer = document.createElement('div');
        inlineFootNoteContainer.classList.add('inline-footnote-container', 'card-surface');
        inlineFootNoteContainer.style.display = 'none';

        // Close button
        const closeBtn = document.createElement('button');
        closeBtn.classList.add('inline-footnote-close');
        closeBtn.innerHTML = 'Ã—';
        closeBtn.setAttribute('aria-label', 'Close footnote');
        closeBtn.addEventListener('click', () => {
          inlineFootNoteContainer.style.display = 'none';
        });

        inlineFootNoteContainer.appendChild(closeBtn);
        inlineFootNoteContainer.appendChild(footnoteElement.firstElementChild.cloneNode(true));
        closestBlock.insertAdjacentElement('afterend', inlineFootNoteContainer);

        elm.addEventListener('click', e => {
          e.preventDefault();
          inlineFootNoteContainer.style.display =
            inlineFootNoteContainer.style.display === 'none' ? 'block' : 'none';
        });
      });
    </script>
  </body>
</html>
